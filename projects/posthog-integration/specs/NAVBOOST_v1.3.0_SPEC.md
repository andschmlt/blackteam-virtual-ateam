# NavBoost Tracker v1.3.0 Specification

**Project:** PostHog NavBoost Integration
**Version:** 1.3.0
**Codename:** "Smart CTA Detection"
**Created:** 2026-02-03
**Authors:** W-IVAN (Tech Lead), W-WOL (Director)

---

## Executive Summary

NavBoost v1.3.0 introduces a **3-tier CTA identification system** that intelligently determines CTA identity using multiple fallback strategies. This ensures consistent CTA tracking even when HTML attributes are missing.

---

## Problem Statement

### Current Issues (v1.2.1)

1. **Random CTA IDs:** `generateCtaId()` creates random IDs like `a_play_now_x7k2`, making it impossible to track the same CTA across sessions
2. **No Consistency:** The same "Play Now" button generates different IDs on each pageview
3. **Poor Attribution:** Can't answer "Which specific CTA drives the most conversions?"
4. **Missing Detection:** Some CTAs aren't detected because selectors don't match

### User Request

> "Try to find and use all 3 options, whenever we are not getting CTA data, or after we manually give class names or point to the right /go/ path for outbound clicks tracking"

---

## Solution: 3-Tier CTA Identification System

### Tier Priority

```
┌─────────────────────────────────────────────────────────────────┐
│  TIER 1: EXPLICIT HTML ATTRIBUTES (Highest Priority)            │
│  ─────────────────────────────────────────────────────────────  │
│  Check: data-cta-id, data-cta-name, id attribute                │
│  Example: <a data-cta-id="header-signup-betway">                │
│  Result: "header-signup-betway"                                 │
│                                                                  │
│  ↓ If not found...                                              │
│                                                                  │
│  TIER 2: URL PATTERN DERIVATION (Medium Priority)               │
│  ─────────────────────────────────────────────────────────────  │
│  Check: /go/, /out/, /aff/, affiliate domains                   │
│  Example: href="/go/betway-casino"                              │
│  Result: "affiliate_betway-casino"                              │
│                                                                  │
│  ↓ If not found...                                              │
│                                                                  │
│  TIER 3: POSITION + ELEMENT FINGERPRINT (Fallback)              │
│  ─────────────────────────────────────────────────────────────  │
│  Check: cta_type + normalized_text + element_position           │
│  Example: Button "Sign Up" in header, 2nd CTA element           │
│  Result: "button_signup_header_pos2"                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Specifications

### Tier 1: Explicit HTML Attributes

**Priority Order:**
1. `data-cta-id` - Explicit CTA identifier (recommended)
2. `data-cta-name` - Alternative attribute name
3. `id` - Element ID (if meaningful, not auto-generated)

**Validation Rules:**
- Must not be empty
- Must not be auto-generated (no `wp-block-1234` patterns)
- Must be alphanumeric with dashes/underscores only

**Implementation:**

```javascript
function getExplicitCtaId(el) {
    // Priority 1: data-cta-id (recommended)
    var explicitId = el.getAttribute('data-cta-id');
    if (explicitId && isValidCtaId(explicitId)) {
        return { id: explicitId, tier: 1, method: 'data-cta-id' };
    }

    // Priority 2: data-cta-name
    var ctaName = el.getAttribute('data-cta-name');
    if (ctaName && isValidCtaId(ctaName)) {
        return { id: ctaName, tier: 1, method: 'data-cta-name' };
    }

    // Priority 3: id attribute (if meaningful)
    var elementId = el.id;
    if (elementId && isValidCtaId(elementId) && !isAutoGeneratedId(elementId)) {
        return { id: elementId, tier: 1, method: 'element-id' };
    }

    return null;
}

function isValidCtaId(id) {
    return id &&
           id.length > 2 &&
           id.length < 100 &&
           /^[a-zA-Z0-9_-]+$/.test(id);
}

function isAutoGeneratedId(id) {
    // Reject WordPress/React auto-generated IDs
    return /^(wp-block-|block-|react-|el-|ember|ng-)\d+/.test(id) ||
           /^[a-f0-9]{8,}$/.test(id) ||  // UUID-like
           /^\d+$/.test(id);              // Pure numbers
}
```

---

### Tier 2: URL Pattern Derivation

**Patterns to Extract:**

| URL Pattern | ID Format | Example |
|-------------|-----------|---------|
| `/go/{name}` | `affiliate_{name}` | `/go/betway` → `affiliate_betway` |
| `/out/{name}` | `outbound_{name}` | `/out/draftkings` → `outbound_draftkings` |
| `/aff/{name}` | `affiliate_{name}` | `/aff/888casino` → `affiliate_888casino` |
| `?ref={name}` | `referral_{name}` | `?ref=poker` → `referral_poker` |
| External domain | `external_{domain}` | `betway.com` → `external_betway_com` |
| Social share | `social_{platform}` | `twitter.com/intent` → `social_twitter` |

**Implementation:**

```javascript
function deriveCtaIdFromUrl(href, el) {
    if (!href) return null;

    // Pattern 1: /go/ affiliate links
    var goMatch = href.match(/\/go\/([a-zA-Z0-9_-]+)/i);
    if (goMatch) {
        return {
            id: 'affiliate_' + goMatch[1].toLowerCase(),
            tier: 2,
            method: 'url-go-pattern'
        };
    }

    // Pattern 2: /out/ outbound links
    var outMatch = href.match(/\/out\/([a-zA-Z0-9_-]+)/i);
    if (outMatch) {
        return {
            id: 'outbound_' + outMatch[1].toLowerCase(),
            tier: 2,
            method: 'url-out-pattern'
        };
    }

    // Pattern 3: /aff/ affiliate links
    var affMatch = href.match(/\/aff\/([a-zA-Z0-9_-]+)/i);
    if (affMatch) {
        return {
            id: 'affiliate_' + affMatch[1].toLowerCase(),
            tier: 2,
            method: 'url-aff-pattern'
        };
    }

    // Pattern 4: ?ref= referral parameter
    var refMatch = href.match(/[?&]ref=([a-zA-Z0-9_-]+)/i);
    if (refMatch) {
        return {
            id: 'referral_' + refMatch[1].toLowerCase(),
            tier: 2,
            method: 'url-ref-param'
        };
    }

    // Pattern 5: Social share URLs
    if (/twitter\.com\/intent|x\.com\/intent/i.test(href)) {
        return { id: 'social_twitter', tier: 2, method: 'url-social' };
    }
    if (/facebook\.com\/sharer/i.test(href)) {
        return { id: 'social_facebook', tier: 2, method: 'url-social' };
    }
    if (/linkedin\.com\/share/i.test(href)) {
        return { id: 'social_linkedin', tier: 2, method: 'url-social' };
    }
    if (/reddit\.com\/submit/i.test(href)) {
        return { id: 'social_reddit', tier: 2, method: 'url-social' };
    }

    // Pattern 6: Known affiliate domains
    var knownAffiliates = [
        'betonlineaffiliates', 'masteraffiliates', 'sportsbettingaffiliates',
        'affiliatemystake', 'affision', 'webpartners', 'revmasters',
        'thunder.partners', 'toponepartners', 'everygame', 'superiorshare'
    ];

    for (var i = 0; i < knownAffiliates.length; i++) {
        if (href.toLowerCase().indexOf(knownAffiliates[i]) !== -1) {
            return {
                id: 'affiliate_' + knownAffiliates[i].replace(/\./g, '_'),
                tier: 2,
                method: 'url-affiliate-domain'
            };
        }
    }

    // Pattern 7: External domain (general)
    try {
        var url = new URL(href, window.location.origin);
        if (url.hostname !== window.location.hostname) {
            var domain = url.hostname.replace(/^www\./, '').replace(/\./g, '_');
            return {
                id: 'external_' + domain,
                tier: 2,
                method: 'url-external-domain'
            };
        }
    } catch (e) {}

    return null;
}
```

---

### Tier 3: Position + Element Fingerprint

**Fingerprint Components:**
1. **cta_type** - Derived from element/class analysis
2. **normalized_text** - First 20 chars of CTA text, normalized
3. **container_region** - header, footer, sidebar, content, modal
4. **position_index** - Nth CTA element in container

**Implementation:**

```javascript
function generateFingerprintCtaId(el) {
    var ctaType = getCtaType(el);
    var normalizedText = normalizeCtaText(getCtaText(el));
    var region = detectContainerRegion(el);
    var posIndex = getPositionInContainer(el, region);

    // Format: {type}_{text}_{region}_pos{n}
    var id = ctaType + '_' + normalizedText;
    if (region && region !== 'content') {
        id += '_' + region;
    }
    if (posIndex > 0) {
        id += '_pos' + posIndex;
    }

    return {
        id: id,
        tier: 3,
        method: 'fingerprint',
        components: {
            type: ctaType,
            text: normalizedText,
            region: region,
            position: posIndex
        }
    };
}

function normalizeCtaText(text) {
    if (!text) return 'unnamed';
    return text
        .toLowerCase()
        .trim()
        .substring(0, 20)
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '')
        || 'unnamed';
}

function detectContainerRegion(el) {
    var element = el;
    var iterations = 0;

    while (element && element !== document.body && iterations < 20) {
        var tag = element.tagName ? element.tagName.toLowerCase() : '';
        var classes = element.className || '';
        var id = element.id || '';
        var combined = (tag + ' ' + classes + ' ' + id).toLowerCase();

        if (tag === 'header' || /header|masthead|top-bar/i.test(combined)) {
            return 'header';
        }
        if (tag === 'footer' || /footer|bottom-bar/i.test(combined)) {
            return 'footer';
        }
        if (tag === 'aside' || /sidebar|side-bar|widget-area/i.test(combined)) {
            return 'sidebar';
        }
        if (tag === 'nav' || /navigation|menu|navbar/i.test(combined)) {
            return 'nav';
        }
        if (/modal|popup|overlay|dialog/i.test(combined)) {
            return 'modal';
        }
        if (/hero|banner|jumbotron/i.test(combined)) {
            return 'hero';
        }
        if (tag === 'article' || /article|post-content|entry-content/i.test(combined)) {
            return 'article';
        }

        element = element.parentNode;
        iterations++;
    }

    return 'content';
}

function getPositionInContainer(el, region) {
    try {
        // Find container
        var container = document.body;
        if (region === 'header') container = document.querySelector('header') || container;
        if (region === 'footer') container = document.querySelector('footer') || container;
        if (region === 'sidebar') container = document.querySelector('aside, [class*="sidebar"]') || container;

        // Get all CTAs in container
        var allCtas = container.querySelectorAll(CONFIG.CTA_SELECTORS.join(','));

        for (var i = 0; i < allCtas.length; i++) {
            if (allCtas[i] === el) {
                return i + 1;
            }
        }
    } catch (e) {}

    return 0;
}
```

---

### Master CTA ID Generator

**Unified function that uses all 3 tiers:**

```javascript
/**
 * Generate CTA ID using 3-tier fallback system
 * @param {HTMLElement} el - The CTA element
 * @returns {Object} { id, tier, method, [components] }
 */
function generateSmartCtaId(el) {
    // Tier 1: Explicit HTML attributes
    var tier1Result = getExplicitCtaId(el);
    if (tier1Result) {
        log('CTA ID (Tier 1):', tier1Result.id, 'via', tier1Result.method);
        return tier1Result;
    }

    // Tier 2: URL pattern derivation
    var href = el.href || el.getAttribute('href') || '';
    var tier2Result = deriveCtaIdFromUrl(href, el);
    if (tier2Result) {
        log('CTA ID (Tier 2):', tier2Result.id, 'via', tier2Result.method);
        return tier2Result;
    }

    // Tier 3: Position + element fingerprint
    var tier3Result = generateFingerprintCtaId(el);
    log('CTA ID (Tier 3):', tier3Result.id, 'via fingerprint');
    return tier3Result;
}
```

---

## Event Schema Changes (v1.3.0)

### Enhanced CTA Event Properties

| Property | Type | Description | New in v1.3.0 |
|----------|------|-------------|---------------|
| `cta_id` | string | Smart CTA identifier | Enhanced |
| `cta_id_tier` | number | Which tier generated the ID (1, 2, 3) | NEW |
| `cta_id_method` | string | Specific method used | NEW |
| `cta_region` | string | Container region (header, footer, etc.) | NEW |
| `cta_position` | number | Position index in region | NEW |
| `cta_href_pattern` | string | Detected URL pattern type | NEW |

### Example Event Payload

```json
{
    "event": "navboost:cta_click",
    "properties": {
        "cta_id": "affiliate_betway",
        "cta_id_tier": 2,
        "cta_id_method": "url-go-pattern",
        "cta_type": "link",
        "cta_text": "Play Now at Betway",
        "cta_href": "/go/betway",
        "cta_region": "article",
        "cta_position": 3,
        "cta_href_pattern": "/go/",
        "page_path": "/casino-reviews/betway-review/",
        "time_to_click": 45,
        "was_visible": true,
        "tracker_version": "1.3.0"
    }
}
```

---

## Configuration: Known URL Patterns

### Configurable Affiliate Patterns

```javascript
CONFIG.AFFILIATE_URL_PATTERNS = [
    // Path patterns
    { pattern: /\/go\/([a-zA-Z0-9_-]+)/i, prefix: 'affiliate', capture: 1 },
    { pattern: /\/out\/([a-zA-Z0-9_-]+)/i, prefix: 'outbound', capture: 1 },
    { pattern: /\/aff\/([a-zA-Z0-9_-]+)/i, prefix: 'affiliate', capture: 1 },
    { pattern: /\/partner\/([a-zA-Z0-9_-]+)/i, prefix: 'partner', capture: 1 },

    // Query parameter patterns
    { pattern: /[?&]ref=([a-zA-Z0-9_-]+)/i, prefix: 'referral', capture: 1 },
    { pattern: /[?&]aff=([a-zA-Z0-9_-]+)/i, prefix: 'affiliate', capture: 1 },
    { pattern: /[?&]partner=([a-zA-Z0-9_-]+)/i, prefix: 'partner', capture: 1 }
];

CONFIG.KNOWN_AFFILIATE_DOMAINS = [
    'betonlineaffiliates.com',
    'masteraffiliates.com',
    'sportsbettingaffiliates.com',
    'go.affiliatemystake.com',
    'go.affision.com',
    'record.webpartners.co',
    'record.revmasters.com',
    'go.thunder.partners',
    'records.toponepartners.com',
    'link.everygame.eu',
    'record.superiorshare.com'
];
```

---

## Manual Override: data-cta-id Attribute

### Recommended HTML Implementation

**For Content Team / Developers:**

```html
<!-- Affiliate CTAs -->
<a href="/go/betway" data-cta-id="betway-play-now-hero">Play Now</a>
<a href="/go/888casino" data-cta-id="888casino-bonus-sidebar">Get Bonus</a>

<!-- Newsletter CTAs -->
<button data-cta-id="newsletter-footer">Subscribe</button>
<form data-cta-id="newsletter-popup-modal">...</form>

<!-- Social Share CTAs -->
<a href="..." data-cta-id="share-twitter-article">Tweet</a>
<a href="..." data-cta-id="share-facebook-article">Share</a>

<!-- Navigation CTAs -->
<a href="/signup" data-cta-id="signup-header">Sign Up Free</a>
<a href="/login" data-cta-id="login-header">Log In</a>
```

### Naming Convention

```
{action}-{brand/type}-{location}

Examples:
- betway-play-now-hero
- newsletter-subscribe-footer
- share-twitter-article
- signup-header
- bonus-claim-sidebar
```

---

## Diagnostic Mode: CTA Detection Report

### New Event: navboost:cta_diagnostic

**Purpose:** Help identify missing CTAs and validate detection

```javascript
function runCtaDiagnostic() {
    var allLinks = document.querySelectorAll('a[href], button');
    var ctaElements = document.querySelectorAll(CONFIG.CTA_SELECTORS.join(','));
    var diagnosticData = {
        total_links: allLinks.length,
        detected_ctas: ctaElements.length,
        detection_rate: Math.round((ctaElements.length / allLinks.length) * 100),
        cta_breakdown: {},
        undetected_potential_ctas: [],
        tier_distribution: { 1: 0, 2: 0, 3: 0 }
    };

    // Analyze detected CTAs
    ctaElements.forEach(function(el) {
        var ctaIdResult = generateSmartCtaId(el);
        diagnosticData.tier_distribution[ctaIdResult.tier]++;

        var type = getCtaType(el);
        diagnosticData.cta_breakdown[type] = (diagnosticData.cta_breakdown[type] || 0) + 1;
    });

    // Find potential undetected CTAs
    allLinks.forEach(function(el) {
        if (!elementMatchesCTA(el)) {
            var href = el.href || '';
            // Check if it looks like an affiliate link
            if (/\/go\/|\/out\/|affiliate|sponsored/i.test(href) ||
                (el.rel && /sponsored|nofollow/i.test(el.rel))) {
                diagnosticData.undetected_potential_ctas.push({
                    href: href,
                    text: (el.innerText || '').substring(0, 50),
                    classes: el.className,
                    suggestion: 'Add to CTA_SELECTORS or use data-cta-id'
                });
            }
        }
    });

    trackEvent('navboost:cta_diagnostic', diagnosticData);
    console.table(diagnosticData.undetected_potential_ctas);

    return diagnosticData;
}

// Run diagnostic on demand (for debugging)
window.navboostDiagnostic = runCtaDiagnostic;
```

---

## Migration Path

### v1.2.1 → v1.3.0

| Step | Action | Breaking Change? |
|------|--------|------------------|
| 1 | Deploy v1.3.0 tracker | No |
| 2 | Existing CTAs continue to work | No |
| 3 | New CTAs get smarter IDs | No |
| 4 | Add data-cta-id to key CTAs | Optional |
| 5 | Run diagnostic to find gaps | Recommended |

### Backward Compatibility

- All v1.2.1 events remain valid
- New properties are additive
- No breaking changes to existing queries

---

## Testing Checklist

### Unit Tests

- [ ] Tier 1: data-cta-id extraction
- [ ] Tier 1: Rejects auto-generated IDs
- [ ] Tier 2: /go/ pattern extraction
- [ ] Tier 2: /out/ pattern extraction
- [ ] Tier 2: Social URL detection
- [ ] Tier 2: Affiliate domain detection
- [ ] Tier 3: Region detection (header, footer, sidebar)
- [ ] Tier 3: Position indexing
- [ ] Tier 3: Text normalization
- [ ] Integration: Tier fallback order

### Integration Tests

- [ ] CTA visible events have smart IDs
- [ ] CTA click events have smart IDs
- [ ] Tier distribution is logged correctly
- [ ] Diagnostic mode works
- [ ] No performance regression (< 5ms per CTA)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.3.0 | 2026-02-03 | Smart CTA ID system, 3-tier fallback, diagnostic mode |
| 1.2.1 | 2026-01-28 | CTA template system |
| 1.2.0 | 2026-01-26 | Heartbeat, error logging |
| 1.1.0 | 2026-01-21 | Conversion tracking |
| 1.0.0 | 2026-01-16 | Initial release |

---

*Specification by W-IVAN (Tech Lead) | WhiteTeam | WT-2026-007*
*Approved by W-WOL (Director)*
